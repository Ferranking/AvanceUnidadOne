<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo - Delivery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .content {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos del Mapa */
        .map-section {
            grid-column: 1 / -1;
        }

        .map-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .city-map {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            border-radius: 10px;
            position: relative;
            border: 3px solid #34495e;
            overflow: hidden;
        }

        .location {
            position: absolute;
            width: 70px;
            height: 70px;
            background: white;
            border: 3px solid #2c3e50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            text-align: center;
            font-size: 12px;
            padding: 5px;
        }

        .location:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .location.selected-origin {
            background: #e74c3c !important;
            color: white;
            border-color: #c0392b;
            animation: pulse 2s infinite;
        }

        .location.selected-start {
            background: #f39c12 !important;
            color: white;
            border-color: #d35400;
            animation: pulse 2s infinite;
        }

        .location.selected-end {
            background: #27ae60 !important;
            color: white;
            border-color: #229954;
            animation: pulse 2s infinite;
        }

        .location.in-route {
            background: #3498db !important;
            color: white;
            border-color: #2980b9;
        }

        .connection {
            position: absolute;
            background: #7f8c8d;
            height: 3px;
            transform-origin: 0 0;
            z-index: 1;
            opacity: 0.7;
        }

        .connection.route-active {
            background: #e74c3c;
            height: 6px;
            opacity: 1;
            z-index: 2;
        }

        .connection-label {
            position: absolute;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            z-index: 3;
            pointer-events: none;
        }

        /* Panel de Control */
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Resultados */
        .result-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-top: 20px;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #3498db;
        }

        .result.success {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }

        .result.error {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }

        .path-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .path-step {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-weight: 500;
        }

        .path-step.origin {
            background: #e74c3c;
        }

        .path-step.start {
            background: #f39c12;
        }

        .path-step.end {
            background: #27ae60;
        }

        .distance {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Mapa Interactivo - Sistema Delivery</h1>
            <p>Visualiza y calcula rutas en el mapa interactivo</p>
            <div class="nav-buttons">
                <a href="/" class="nav-btn"> Vista Original</a>
                <a href="/map" class="nav-btn"> Vista Mapa</a>
            </div>
        </div>

        <div class="content">
            <!-- Mapa Interactivo -->
            <div class="map-section">
                <div class="map-title"> Mapa de la Ciudad - Haz clic en las ubicaciones</div>
                <div class="city-map" id="cityMap">
                    <!-- Mapa se genera con JavaScript -->
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c; border-color: #c0392b;"></div>
                        <span>Origen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12; border-color: #d35400;"></div>
                        <span>Pizzería</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #27ae60; border-color: #229954;"></div>
                        <span>Cliente</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db; border-color: #2980b9;"></div>
                        <span>En Ruta</span>
                    </div>
                </div>
            </div>

            <!-- Panel de Control -->
            <div class="control-panel">
                <h3> Configurar Ruta de Delivery</h3>
                
                <div class="form-group">
                    <label for="origin"> Punto de Origen:</label>
                    <select id="origin">
                        <option value="">Selecciona origen</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="start"> Punto de Recojo (Pizzería):</label>
                    <select id="start">
                        <option value="">Selecciona pizzería</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="end"> Punto de Entrega (Cliente):</label>
                    <select id="end">
                        <option value="">Selecciona cliente</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="clearSelection()"> Limpiar</button>
                    <button class="btn-primary" onclick="calculateRoute()"> Calcular Ruta</button>
                </div>
            </div>

            <!-- Resultados -->
            <div class="result-section">
                <h3> Resultados de la Ruta</h3>
                <div id="loading" class="loading hidden">
                    <p>Calculando la mejor ruta...</p>
                </div>
                <div id="result"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuración del mapa
        const locationPositions = {
            "Casa": { x: 100, y: 400, color: "#1abc9c" },
            "Pizzería": { x: 250, y: 300, color: "#e74c3c" },
            "Oficina": { x: 600, y: 450, color: "#3498db" },
            "Parque": { x: 400, y: 250, color: "#27ae60" },
            "Escuela": { x: 700, y: 350, color: "#9b59b6" },
            "Hospital": { x: 800, y: 400, color: "#e67e22" },
            "Centro": { x: 450, y: 150, color: "#f1c40f" },
            "Mercado": { x: 300, y: 100, color: "#d35400" },
            "Estadio": { x: 900, y: 300, color: "#2ecc71" },
            "Universidad": { x: 850, y: 200, color: "#8e44ad" }
        };

        const connections = [
            { from: "Casa", to: "Pizzería", distance: 3 },
            { from: "Casa", to: "Oficina", distance: 5 },
            { from: "Casa", to: "Parque", distance: 2 },
            { from: "Pizzería", to: "Centro", distance: 4 },
            { from: "Pizzería", to: "Mercado", distance: 3 },
            { from: "Oficina", to: "Escuela", distance: 6 },
            { from: "Oficina", to: "Hospital", distance: 4 },
            { from: "Parque", to: "Escuela", distance: 3 },
            { from: "Parque", to: "Estadio", distance: 5 },
            { from: "Centro", to: "Hospital", distance: 2 },
            { from: "Centro", to: "Universidad", distance: 7 },
            { from: "Mercado", to: "Universidad", distance: 4 },
            { from: "Escuela", to: "Estadio", distance: 3 },
            { from: "Hospital", to: "Universidad", distance: 5 },
            { from: "Estadio", to: "Universidad", distance: 6 }
        ];

        let currentRoute = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableNodes();
            initializeMap();
        });

        function initializeMap() {
            drawConnections();
            drawLocations();
        }

        function drawLocations() {
            const map = document.getElementById('cityMap');
            
            Object.keys(locationPositions).forEach(location => {
                const pos = locationPositions[location];
                
                const locationEl = document.createElement('div');
                locationEl.className = 'location';
                locationEl.id = `location-${location}`;
                locationEl.textContent = location;
                locationEl.style.left = `${pos.x}px`;
                locationEl.style.top = `${pos.y}px`;
                locationEl.style.background = pos.color;
                locationEl.title = `Haz clic para seleccionar: ${location}`;
                
                locationEl.addEventListener('click', () => handleLocationClick(location));
                
                map.appendChild(locationEl);
            });
        }

        function drawConnections() {
            const map = document.getElementById('cityMap');
            
            connections.forEach(conn => {
                const fromPos = locationPositions[conn.from];
                const toPos = locationPositions[conn.to];
                
                // Línea de conexión
                const connection = createConnectionLine(fromPos, toPos, conn.distance, false);
                connection.id = `connection-${conn.from}-${conn.to}`;
                map.appendChild(connection);
                
                // Etiqueta de distancia
                const label = createDistanceLabel(fromPos, toPos, conn.distance);
                map.appendChild(label);
            });
        }

        function createConnectionLine(fromPos, toPos, distance, isActive) {
            const dx = toPos.x - fromPos.x;
            const dy = toPos.y - fromPos.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            const connection = document.createElement('div');
            connection.className = `connection ${isActive ? 'route-active' : ''}`;
            connection.style.width = `${length}px`;
            connection.style.left = `${fromPos.x + 35}px`;
            connection.style.top = `${fromPos.y + 35}px`;
            connection.style.transform = `rotate(${angle}deg)`;
            
            return connection;
        }

        function createDistanceLabel(fromPos, toPos, distance) {
            const label = document.createElement('div');
            label.className = 'connection-label';
            label.textContent = distance;
            label.style.left = `${(fromPos.x + toPos.x) / 2}px`;
            label.style.top = `${(fromPos.y + toPos.y) / 2}px`;
            
            return label;
        }

        function handleLocationClick(locationName) {
            const selects = [
                { id: 'origin', class: 'selected-origin' },
                { id: 'start', class: 'selected-start' }, 
                { id: 'end', class: 'selected-end' }
            ];
            
            // Encontrar el primer select vacío
            for (let selectConfig of selects) {
                const select = document.getElementById(selectConfig.id);
                if (!select.value) {
                    select.value = locationName;
                    updateMapSelection();
                    break;
                }
            }
        }

        function updateMapSelection() {
            // Resetear todas las ubicaciones
            document.querySelectorAll('.location').forEach(el => {
                el.className = 'location';
                const locationName = el.id.replace('location-', '');
                el.style.background = locationPositions[locationName]?.color || '#3498db';
            });
            
            // Aplicar selecciones actuales
            const origin = document.getElementById('origin').value;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            
            if (origin) {
                const originEl = document.getElementById(`location-${origin}`);
                originEl.classList.add('selected-origin');
            }
            
            if (start) {
                const startEl = document.getElementById(`location-${start}`);
                startEl.classList.add('selected-start');
            }
            
            if (end) {
                const endEl = document.getElementById(`location-${end}`);
                endEl.classList.add('selected-end');
            }
        }

        function clearSelection() {
            document.getElementById('origin').value = '';
            document.getElementById('start').value = '';
            document.getElementById('end').value = '';
            clearRouteVisualization();
            updateMapSelection();
        }

        function loadAvailableNodes() {
            fetch('/get_nodes')
                .then(response => response.json())
                .then(data => {
                    const selects = ['origin', 'start', 'end'];
                    
                    selects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        while (select.children.length > 1) select.removeChild(select.lastChild);
                        
                        data.nodes.forEach(node => {
                            const option = new Option(node, node);
                            select.add(option);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    showResult('Error al cargar los nodos disponibles', false);
                });
        }

        function calculateRoute() {
            const origin = document.getElementById('origin').value;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            if (!origin || !start || !end) {
                showResult('Por favor, selecciona todos los puntos.', false);
                return;
            }

            if (origin === start || origin === end || start === end) {
                showResult('Los tres puntos deben ser diferentes.', false);
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            clearRouteVisualization();

            fetch('/calculate_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    origin: origin,
                    start: start,
                    end: end
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                displayResult(data);
                visualizeRoute(data);
            })
            .catch(error => {
                document.getElementById('loading').classList.add('hidden');
                console.error('Error:', error);
                showResult('Error al calcular la ruta', false);
            });
        }

        function visualizeRoute(routeData) {
            if (!routeData.success) return;
            
            currentRoute = routeData;
            const fullPath = routeData.full_path;
            
            // Resaltar ubicaciones en la ruta
            fullPath.forEach(location => {
                const locationEl = document.getElementById(`location-${location}`);
                locationEl.classList.add('in-route');
            });
            
            // Dibujar conexiones de la ruta
            for (let i = 0; i < fullPath.length - 1; i++) {
                const from = fullPath[i];
                const to = fullPath[i + 1];
                const fromPos = locationPositions[from];
                const toPos = locationPositions[to];
                
                // Encontrar la distancia
                const connection = connections.find(conn => 
                    (conn.from === from && conn.to === to) || 
                    (conn.from === to && conn.to === from)
                );
                
                if (connection) {
                    const routeLine = createConnectionLine(fromPos, toPos, connection.distance, true);
                    routeLine.id = `route-${from}-${to}`;
                    document.getElementById('cityMap').appendChild(routeLine);
                }
            }
        }

        function clearRouteVisualization() {
            // Limpiar líneas de ruta
            document.querySelectorAll('.route-active').forEach(el => {
                el.remove();
            });
            
            // Limpiar clases de ubicaciones
            document.querySelectorAll('.location').forEach(el => {
                el.classList.remove('in-route');
            });
            
            currentRoute = null;
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            
            if (data.success) {
                let html = `
                    <div class="result success">
                        <h3> Ruta Calculada Exitosamente</h3>
                        <div class="path-display">
                            <strong>Ruta completa:</strong><br>
                `;
                
                data.full_path.forEach((node, index) => {
                    let stepClass = '';
                    if (index === 0) stepClass = 'origin';
                    else if (node === data.path_start_to_end[0]) stepClass = 'start';
                    else if (index === data.full_path.length - 1) stepClass = 'end';
                    
                    html += `<span class="path-step ${stepClass}">${node}</span>`;
                    if (index < data.full_path.length - 1) {
                        html += ' → ';
                    }
                });
                
                html += `
                        </div>
                        <div class="distance">
                             Distancia total: <strong>${data.total_distance} unidades</strong>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Desglose:</strong><br>
                            •  ${data.path_origin_to_start.join(' → ')}<br>
                            •  ${data.path_start_to_end.join(' → ')}
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;
            } else {
                showResult(` Error: ${data.error}`, false);
            }
        }

        function showResult(message, isSuccess) {
            const resultDiv = document.getElementById('result');
            const className = isSuccess ? 'success' : 'error';
            resultDiv.innerHTML = `
                <div class="result ${className}">
                    <h3>${isSuccess ? ' Éxito' : ' Error'}</h3>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>